<div class="container">

  <div class="row mt-3">
    <div class="col-lg-9">
    <!-- Calendar ---------------------------------------------------->
        <%= month_calendar events: @user_records do |date, user_records| %>
          <div class="cell">
            <div class="day-cell">
              <%= date.day %>
            </div>
            <% user_records.each do |r| %>
                <% r.exercises.each do |e| %>
                  <div id="<%= r.id %>"
                    class="inner-cell text-center"
                    data-target="#show-<%= r.id %>"
                    style="background-color:<%= e.colour %>;">
                    <span><%= e.name %></span>
                  </div>
    <%# MODAL below ------------------------------------------------%>
                  <div class="modal fade" id="modal-<%= r.id %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">

                      <div class="modal-content show-modal">
                        <button type="button" class="close ml-auto mr-3 mt-1" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true" style="color:white;">&times;</span>
                        </button>
                          <h5 class="modal-title ml-2" id="exampleModalLongTitle">
                            <%= r.id %>
                          </h5>
                        <div class="modal-body">
                          <% if can?(:crud, r) %>
                              <p>
                                <%= link_to "your record",
                                    record_path(r),
                                    class:"btn btn-light btn-sm btn-block" %>
                                <%= link_to "edit",
                                    edit_record_path(r),
                                    class:"btn btn-light btn-sm btn-block" %>
                                <%= link_to(
                                     'delete',
                                     record_path(r),
                                     class:"btn btn-light btn-sm btn-block",
                                     method: :delete,
                                     data: {confirm: 'Are you sure?'}
                                   )
                                %>
                                <%= link_to 'new record',
                                    "#{new_record_path}?date=#{r.start_time.strftime("%Y-%m-%d")}",
                                    class:"btn btn-light btn-sm btn-block" %>
                              </p>
                          <% end %>

                        </div>
                      </div>

                    </div>
                  </div>
    <%# MODAL above------------------------------------------------%>
                <% end %>
            <% end %>

          </div>
        <% end %>

    </div>

<%# User Info & Buttons ------------------------------------------------------%>

    <div class="col-lg-3">
      <div class="user-info">
        <div class="user-panel">
          <%= link_to @user.first_name, user_path(@user)%>
        </div>
      </div>

      <div class="user-menu">
        <select name="select-year" class="select-year mb-4">
            <option disabled selected value> year </option>
            <% for i in 1..12 %>
              <option value="<%= i.to_s %>">
            <% end %>
            </option>

        </select>

          <%= link_to "Home", home_path,
          class:"btn btn-light btn-sm btn-block mb-4 nav-home group-1" %>

          <%= link_to(
            'Sign Out',
            session_path,
            class: "btn btn-light btn-sm btn-block mb-4 nav-signOut group-1",
            method: :delete,
            data: {confirm: 'Sign out?'}
          ) %>

          <select name="chart-months" class="chart-select mb-4">
              <option disabled selected value> -  select a month  - </option>
              <% @record_months.each do |month, records| %>
              <option value="<%= month.strftime('%Y-%m-%d') %>">
                <%= month.strftime('%B') %>
              </option>
              <% end %>
          </select>
          <a href="#myChart"
              class="btn btn-light btn-sm btn-block mb-4 user-stats group-2">
            Statistics
          </a>

          <button class="btn btn-light btn-sm btn-block mb-4 show-day group-2">
            Toggle Day
          </button>
          <button class="btn btn-light btn-sm btn-block mb-4 show-exe group-2">
            Toggle exercise
          </button>

          <select name="months" class="screenshot-select group-3">
            <option disabled selected value> -  select a month  - </option>
              <% @record_months.each do |month, records| %>
                <option value="<%= month.strftime('%Y-%m-%d') %>">
                  <%= month.strftime('%B') %>
                </option>
              <% end %>
          </select>

          <%= link_to 'Make a screenshot', "#{screenshot_path}?start_date",
              class: "btn btn-light btn-sm btn-block mt-4 screenshot group-3",
              id: "screenshot",
              style: "display:none;" %>

          <script type="text/javascript">
              $('.screenshot-select').change(function(){
                  const selectedMonth = $(this).val(); // get the month value
                  const $screenshotButton = $('#screenshot');
                  const keep = $screenshotButton.attr('href').split('?')[0];
                  const newQuery = `${keep}?start_date=${selectedMonth}`;
                  // #{screenshot_path}?start_date=2018-02-01
                  // $screenshotButton.attr('href') is `/screens?start_date=2018-04-01`
                  // console.log($screenshotButton.attr('href'));
                  $screenshotButton.attr('href',newQuery);
                  $('#screenshot').show('slow');
              })
          </script>

          <% if asset_exists?("image-#{@user.id}-#{@user.first_name}.png") %>
          <%= link_to "click to view",
              asset_path("image-#{@user.id}-#{@user.first_name}.png"),
              class: "btn btn-light btn-sm btn-block mt-4 view-image group-3"%>

          <%= link_to "click to download",
              asset_path("image-#{@user.id}-#{@user.first_name}.png"),
              download: "#{@user.first_name}",
              class: "btn btn-light btn-sm btn-block mt-4 download-image group-3" %>
          <% end %>
      </div>

      <script>

        document.querySelector('a.screenshot').addEventListener('click', ()=>{
          document.querySelector('body').innerHTML =
          `<div class="spinner"></div>
          <div class="loading-info">
            Generating image. Please do not refresh.
          </div>
          `
        })
      </script>

    </div>
  </div>


<%#-Show Screenshot Picture----------------------------------------------%>

  <div class="show-image">
    <!-- <% if asset_exists?("image-#{@user.id}-#{@user.first_name}.png") %>
      <img src="<%= asset_path("image-#{@user.id}-#{@user.first_name}.png") %>" >
    <% else %>
      <small>No image exists</small>
    <% end %> -->
  </div>
<%#-HIDDEN------------------------------------------------------------%>

<div class="all-records">
    <% if @user %>
        <h3><%= @user.first_name %></h3>
        <% @user_records.each do |record| %>
          <p id="show-<%= record.id%>"
            data-toggle="modal"
            data-target="#modal-<%= record.id %>">
            show-<%= record.id %>
          </p>

          <% record.exercises.each do |exe| %>
            <p> <%= exe.name %> </p>
          <% end %>

        <% end %>
    <% else %>
        <h1>later this (all records) will be seen by admin</h1>
        <% @records.each do |record| %>
          <p> <%= link_to record.date,record_path(record) %> </p>
        <% end %>
    <% end %>
</div>

<%#-CHART-----------------------------------------------------------%>

<div class="m-auto pt-5 myChart">
  <canvas id="myChart" width="400" height="400"></canvas>
</div>

<script>
  $('.chart-select').change(function(){
      const selectedMonth = $(this).val();
      Charting.get(`${selectedMonth}`)
              .then(freqPair=>{

          let pairData = [], pairLabel = [];
          for(let key in freqPair){
            pairLabel.push(key);
            pairData.push(freqPair[key]);
          }

          function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
              color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
          }

          let colorArr = [];
          for(let i=1; i<=pairData.length;i++){
            let temp = getRandomColor();
            colorArr.push(temp);
          }

          var ctx = document.getElementById("myChart").getContext('2d');
          var myChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                  datasets: [{
                      data: pairData,
                      backgroundColor: colorArr
                  }],
                  labels: pairLabel
              }
          });
        });

  });

</script>



</div>
